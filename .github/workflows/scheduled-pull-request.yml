name: Scheduled Pull Request
on:
  workflow_dispatch:
  push:
    branches:
      - stage
    
jobs:
  scheduled-pull-request:
    runs-on: common-8gb
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    - name: Create Pull Request
      uses: actions/github-script@v6
      with:
        script: |
          const { repo, owner } = context.repo;

          const comparison = await github.rest.repos.compareCommits({
            owner: owner,
            repo: repo,
            base: 'main',
            head: 'stage'
          });


          
          const commitMessages = comparison.data.commits.map(commit => commit.commit.message).join(" ");
          const extractedTicketCommits = [...new Set(commitMessages.match(/DS-[0-9]+/g))];
          const ticketSummary  = extractedTicketCommits === null ? 'No potentital commits with ticket numbers yet' : extractedTicketCommits.join(" ");

          const currentDate = new Date().toISOString().split('T')[0];

          const pullRequestTitle = `${ticketSummary} : Stage to Master : [insert RFC ticket] RC Release ${currentDate}`

          const pulls = await github.rest.pulls.list({
              owner: owner,
              repo: repo,
              head: 'stage',
              base: 'main',
              state: 'open',
          });

          if (pulls.data.length < 1) {
            await github.rest.pulls.create({
              title: pullRequestTitle,
              owner: owner,
              repo: repo,
              head: 'stage',
              base: 'main'
            });
          } 
          
          else {
            const existingPR = pulls.data[0];
            await github.rest.pulls.update({
              title: pullRequestTitle,
              owner: owner,
              repo: repo,
              pull_number: existingPR.number
            });
          }