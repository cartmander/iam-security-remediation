name: Scheduled Pull Request
on:
  workflow_dispatch:
  schedule:
    - cron: "*/60 * * * *"
    
jobs:
  scheduled-pull-request:
    runs-on: common-8gb
    steps:
    - name: 🐙 Checkout code
      uses: actions/checkout@v3
    - name: Create Pull Request
      uses: actions/github-script@v6
      with:
        script: |
          const { repo, owner } = context.repo;

          const commits = await github.rest.repos.listCommits({
            owner: owner,
            repo: repo,
            sha: 'stage'
          });
        
          const commitMessages = commits.data.map(commit => commit.commit.message).join(" ");

          const extractedMessages = commitMessages.match(/DS-[0-9]+/g);
          const delimitedMessages = extractedMessages ? extractedMessages.join(" ") : "";
          const currentDate = new Date().toISOString().split('T')[0];

          const pullRequestTitle = `DS-1234 DS-5678 : Stage to Master : CHG12345689 RC Release ${currentDate}`

          const pulls = await github.rest.pulls.list({
              owner: owner,
              repo: repo,
              head: context.ref,
              base: 'main',
              state: 'open',
          });

          if (pulls.data.length < 1) {
            await github.rest.pulls.create({
              title: pullRequestTitle,
              owner: owner,
              repo: repo,
              head: 'stage',
              base: 'main',
              body: [
                'This PR is auto-generated by',
                '[actions/github-script](https://github.com/actions/github-script)',
              ].join('\n'),
            });
          } else {
            const existingPR = pulls.data[0];
            await github.rest.pulls.update({
              title: pullRequestTitle,
              owner: owner,
              repo: repo,
              pull_number: existingPR.number,
              body: [
                existingPR.body,
                `Updated by Job ${context.job}`,
              ].join('\n'),
            });
          }